<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>介入実験ページ（完全版）</title>
<style>
  body {
    font-family: "Segoe UI", sans-serif;
    max-width: 600px;
    margin: 50px auto;
    padding: 20px;
    line-height: 1.6;
    background-color: #fafafa;
  }

  h1 {
    font-size: 1.3rem;
    margin-bottom: 0.5rem;
  }

  .question-box {
    background: #fff;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    padding: 15px 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  }

  .question-box p {
    font-weight: 600;
    margin-bottom: 10px;
  }

  label {
    display: block;
    margin: 6px 0;
    cursor: pointer;
  }

  input[type="radio"] {
    margin-right: 6px;
    transform: scale(1.1);
  }

  input[type="text"] {
    width: 100%;
    padding: 8px 10px;
    font-size: 1rem;
    margin-top: 0.4rem;
    border: 1px solid #ccc;
    border-radius: 6px;
    box-sizing: border-box;
  }

  button {
    margin-top: 1rem;
    padding: 10px 14px;
    font-size: 1rem;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: 0.2s ease-in-out;
  }

  button.primary {
    background-color: #1a73e8;
    color: white;
  }

  button.primary:disabled {
    background-color: #b0c8f2;
    color: #f5f5f5;
    cursor: not-allowed;
    opacity: 0.8;
  }

  #timer {
    font-size: 3em;
    color: darkred;
    text-align: center;
  }

  .note {
    font-size: 0.9rem;
    color: #555;
  }
</style>
</head>
<body>

<!-- ===== 介入前アンケート ===== -->
<div id="PreIntMode" style="display:block">
  <form id="surveyForm">

    <div class="question-box" data-question="q2" data-key="entry.807851115">
      <p>参加者id</p>
      <input type="text" name="q2" placeholder="数字を入力">
    </div>
    <div class="question-box" data-question="q1" data-key="entry.58144620">
      <p>Q1：今どれくらい目が覚めていますか？</p>
      <label><input type="radio" name="q1" value="9"> 非常にはっきりと目覚めている</label>
      <label><input type="radio" name="q1" value="8"> とても目覚めている</label>
      <label><input type="radio" name="q1" value="7"> 目覚めている</label>
      <label><input type="radio" name="q1" value="6"> やや目覚めている</label>
      <label><input type="radio" name="q1" value="5"> どちらでもない</label>
      <label><input type="radio" name="q1" value="4"> 眠くなる兆候がある</label>
      <label><input type="radio" name="q1" value="3"> 眠いが，起きている努力は必要ない</label>
      <label><input type="radio" name="q1" value="2"> 眠い，起きている努力が少し必要</label>
      <label><input type="radio" name="q1" value="1"> とても眠い，起きている努力がとても必要，眠気と戦っている</label>
    </div>

    <button class="primary" id="PreSurveyBtn" disabled>回答を送信する</button>
  </form>
</div>

<!-- ===== 介入モード ===== -->
<div id="InterventionMode" style="display:none">
  <div class="question-box">
    <h1>介入1</h1>
    <p>文章を足して画像を面白くしてください</p>

    <img id="Prompts" src="imgs/1.jpg" alt="お題画像" style="max-width:100%; border-radius:6px; border:1px solid #ccc;">

    <label>回答</label>
    <input type="text" id="AnswerBox" placeholder="回答を記入してください">

    <button id="changeButton">お題を変える</button>
    <button id="saveBtn">回答を決定する</button>

    <h1>60秒カウントダウン</h1>
    <div id="timer">60</div>
  </div>
</div>

<!-- ===== 介入後アンケート ===== -->
<div id="AftIntMode" style="display:none">
  <form id="AftsurveyForm">
    <div class="question-box" data-question="a1" data-key="entry.745845663">
      <p>今どれくらい目が覚めていますか？</p>
      <label><input type="radio" name="a1" value="9"> 非常にはっきりと目覚めている</label>
      <label><input type="radio" name="a1" value="8"> とても目覚めている</label>
      <label><input type="radio" name="a1" value="7"> 目覚めている</label>
      <label><input type="radio" name="a1" value="6"> やや目覚めている</label>
      <label><input type="radio" name="a1" value="5"> どちらでもない</label>
      <label><input type="radio" name="a1" value="4"> 眠くなる兆候がある</label>
      <label><input type="radio" name="a1" value="3"> 眠いが，起きている努力は必要ない</label>
      <label><input type="radio" name="a1" value="2"> 眠い，起きている努力が少し必要</label>
      <label><input type="radio" name="a1" value="1"> とても眠い，起きている努力がとても必要，眠気と戦っている</label>
    </div>

    <button class="primary" id="AftSurveyBtn" disabled>回答を送信する</button>
  </form>
</div>

<script>
  // ===== 画面管理 =====
  const screens = [
    document.getElementById("PreIntMode"),
    document.getElementById("InterventionMode"),
    document.getElementById("AftIntMode")
  ];
  let screen_ind = 0;
  const answers = [];

  // ===== 複数質問対応（ラジオ + 自由記述） =====
  function setupSurvey(formId, btnId, openUrl = false) {
    const form = document.getElementById(formId);
    const btn = document.getElementById(btnId);
    const questions = form.querySelectorAll(".question-box");

    // 回答入力チェック
    form.addEventListener("input", () => {
      const allAnswered = Array.from(questions).every(qBox => {
        const name = qBox.dataset.question;
        const input = form.querySelector(`[name="${name}"]`);
        if (!input) return false;
        if (input.type === "radio") {
          return form.querySelector(`input[name="${name}"]:checked`);
        } else if (input.type === "text") {
          return input.value.trim() !== "";
        }
        return false;
      });
      btn.disabled = !allAnswered;
    });

    // 送信処理
    btn.addEventListener("click", e => {
      e.preventDefault();
      questions.forEach(qBox => {
        const name = qBox.dataset.question;
        const key = qBox.dataset.key;
        const input = form.querySelector(`[name="${name}"]`);
        if (!input) return;
        let val = "";
        if (input.type === "radio") {
          const selected = form.querySelector(`input[name="${name}"]:checked`);
          if (selected) val = selected.value;
        } else if (input.type === "text") {
          val = input.value.trim();
        }
        if (val !== "") answers.push([key, val]);
      });

      console.log("answers配列:", answers);

      // 介入後アンケートのみURLを開く
      if (openUrl) {
        const prefilledUrl = generatePrefilledFormUrl(answers, baseurl);
        window.open(prefilledUrl, "_blank");
      }

      changeDisplay();
    });
  }

  // フォームごとに設定
  setupSurvey("surveyForm", "PreSurveyBtn", false);  // 介入前アンケート
  setupSurvey("AftsurveyForm", "AftSurveyBtn", true); // 介入後アンケートでURLを開く

  // ===== 介入画面タイマー =====
  function startTimer() {
    let timeLeft = 60;
    const timer = document.getElementById("timer");
    timer.textContent = timeLeft;
    const countdown = setInterval(() => {
      timeLeft--;
      timer.textContent = timeLeft;
      if (timeLeft <= 0) {
        clearInterval(countdown);
        timer.textContent = "終了！";
        changeDisplay();
      }
    }, 1000);
  }

  function changeDisplay() {
    screens[screen_ind].style.display = "none";
    screen_ind++;
    if (screen_ind < screens.length) {
      screens[screen_ind].style.display = "block";
      if (screens[screen_ind].id === "InterventionMode") startTimer();
    }
  }

  // ===== Googleフォーム事前入力URL生成 =====
  const baseurl = "https://docs.google.com/forms/d/e/1FAIpQLSdsbqueulSnjfVTd1DeLEFhAT4zLj5F4CZX0ZvxiLoCLqytDA/viewform?usp=pp_url";
  function generatePrefilledFormUrl(answers, baseUrl) {
    if (!Array.isArray(answers) || answers.length === 0) return baseUrl;
    const params = answers
      .map(([key, val]) => `${encodeURIComponent(key)}=${encodeURIComponent(val)}`)
      .join("&");
    return `${baseUrl}&${params}`;
  }

  // ===== 介入モード 画像回答管理 =====
  const totalImages = 3;
  let images = Array.from({ length: totalImages }, (_, i) => `imgs/${i + 1}.jpg`);
  let current_index = 0;
  const imgElement = document.getElementById("Prompts");
  const changeButton = document.getElementById("changeButton");
  const saveBtn = document.getElementById("saveBtn");
  const AnswerBox = document.getElementById("AnswerBox");

  const imgkeysque = ["entry.1270584944", "entry.1546562637", "entry.827723848", "entry.1534631744", "entry.101664986"];
  const anskeysque = ["entry.123989728", "entry.1704288844", "entry.1758329231", "entry.1412008365", "entry.1276957276"];

  changeButton.addEventListener("click", () => {
    current_index = (current_index + 1) % images.length;
    imgElement.src = images[current_index];
  });

  saveBtn.addEventListener("click", () => {
    const ansText = AnswerBox.value.trim();
    if (!ansText) return;
    // answers.push([`image${current_index}`, ansText]);
    answers.push([imgkeysque.shift(), images[current_index]]);
    answers.push([anskeysque.shift(), ansText]);
    images.splice(current_index, 1);
    if (images.length === 0) {
      alert("全ての画像への回答が完了しました。");
      return;
    }
    current_index = current_index % images.length;
    imgElement.src = images[current_index];
    AnswerBox.value = "";
  });
</script>

</body>
</html>
