<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>介入実験ページ</title>
<style>
  body {
    font-family: "Segoe UI", sans-serif;
    max-width: 600px;
    margin: 50px auto;
    padding: 20px;
    line-height: 1.6;
    background-color: #fafafa;
  }

  h1 {
    font-size: 1.3rem;
    margin-bottom: 0.5rem;
  }

  /* --- 共通デザイン --- */
  .question-box {
    background: #fff;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    padding: 15px 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  }

  .question-box p {
    font-weight: 600;
    margin-bottom: 10px;
  }

  label {
    display: block;
    margin: 6px 0;
    cursor: pointer;
  }

  input[type="radio"] {
    margin-right: 6px;
    transform: scale(1.1);
  }

  input[type="text"] {
    width: 100%;
    padding: 8px 10px;
    font-size: 1rem;
    margin-top: 0.4rem;
    border: 1px solid #ccc;
    border-radius: 6px;
    box-sizing: border-box;
  }

  /* --- ボタン --- */
  button {
    margin-top: 1rem;
    padding: 10px 14px;
    font-size: 1rem;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: 0.2s ease-in-out;
  }

  button.primary {
    background-color: #1a73e8;
    color: white;
  }

  button.primary:disabled {
    background-color: #b0c8f2;
    color: #f5f5f5;
    cursor: not-allowed;
    opacity: 0.8;
  }

  #timer {
    font-size: 3em;
    color: darkred;
    text-align: center;
  }
</style>
</head>
<body>

<!---------------- 介入前アンケート画面 ---------------->
<div id="PreIntMode" style="display:block">
  <form id="surveyForm">

    <div class="question-box" data-question="q1" data-key="entry.58144620">
      <p>Q1：今どれくらい目が覚めていますか？</p>
      <label><input type="radio" name="q1" value="9"> 非常にはっきりと目覚めている</label>
      <label><input type="radio" name="q1" value="8"> とても目覚めている</label>
      <label><input type="radio" name="q1" value="7"> 目覚めている</label>
      <label><input type="radio" name="q1" value="6"> やや目覚めている</label>
      <label><input type="radio" name="q1" value="5"> どちらでもない</label>
      <label><input type="radio" name="q1" value="4"> 眠くなる兆候がある</label>
      <label><input type="radio" name="q1" value="3"> 眠いが，起きている努力は必要ない</label>
      <label><input type="radio" name="q1" value="2"> 眠い，起きている努力が少し必要</label>
      <label><input type="radio" name="q1" value="1"> とても眠い，起きている努力がとても必要，眠気と戦っている</label>
    </div>

    <button class="primary" id="PreSurveyBtn" disabled>回答を送信する</button>
  </form>
</div>

<!---------------- 介入モード画面 ---------------->
<div id="InterventionMode" style="display:none">
  <div class="question-box">
    <h1>介入1</h1>
    <p>文章を足して画像を面白くしてください</p>

    <img id="Prompts" src="imgs/1.jpg" alt="お題画像" style="max-width:100%; border-radius:6px; border:1px solid #ccc;">

    <label>回答</label>
    <input type="text" id="AnswerBox" placeholder="回答を記入してください">

    <button id="changeButton">お題を変える</button>
    <button id="saveBtn">回答を決定する</button>

    <h1>60秒カウントダウン</h1>
    <div id="timer">60</div>
  </div>
</div>

<!------------------- 介入後アンケート画面（例） ------------------->
<div id="AftIntMode" style="display:none">
  <form id="AftsurveyForm">
    <div class="question-box" data-question="a1" data-key="entry.745845663">
      <p>今どれくらい目が覚めていますか？</p>
      <label><input type="radio" name="a1" value="9"> 非常にはっきりと目覚めている</label>
      <label><input type="radio" name="a1" value="8"> とても目覚めている</label>
      <label><input type="radio" name="a1" value="7"> 目覚めている</label>
      <label><input type="radio" name="a1" value="6"> やや目覚めている</label>
      <label><input type="radio" name="a1" value="5"> どちらでもない</label>
      <label><input type="radio" name="a1" value="4"> 眠くなる兆候がある</label>
      <label><input type="radio" name="a1" value="3"> 眠いが，起きている努力は必要ない</label>
      <label><input type="radio" name="a1" value="2"> 眠い，起きている努力が少し必要</label>
      <label><input type="radio" name="a1" value="1"> とても眠い，起きている努力がとても必要，眠気と戦っている</label>
    </div>
    <div class="question-box" data-question="a2" data-key="entry.1270584944">
      <p>周りの目を気にすることなく使えましたか？</p>
      <label><input type="radio" name="a2" value="7"> 全く気にならなかった</label>
      <label><input type="radio" name="a2" value="6"> ほとんど気にならなかった</label>
      <label><input type="radio" name="a2" value="5"> あまり気にならなかった</label>
      <label><input type="radio" name="a2" value="4"> どちらでもない</label>
      <label><input type="radio" name="a2" value="3"> 少し気になった</label>
      <label><input type="radio" name="a2" value="2"> やや気になった</label>
      <label><input type="radio" name="a2" value="1"> 非常に気になった</label>
    </div>
    <button class="primary" id="AftSurveyBtn" disabled>回答を送信する</button>
  </form>
</div>

<script>
  // ======== 画面管理 ========
  const screens = [
    document.getElementById("PreIntMode"),
    document.getElementById("InterventionMode"),
    document.getElementById("AftIntMode")
  ];
  let screen_ind = 0;
  const answers = [];

  // ======== 複数質問対応：全回答チェック ========
   function setupSurvey(formId, btnId) {
    const form = document.getElementById(formId);
    const btn = document.getElementById(btnId);
    const questions = form.querySelectorAll(".question-box");

    // 回答状態チェック
    form.addEventListener("change", () => {
      console.log("changed");
      const allAnswered = Array.from(questions).every(qBox => {
        const name = qBox.dataset.question;
        return form.querySelector(`input[name="${name}"]:checked`);
      });
      btn.disabled = !allAnswered;
    });

    // 送信時の処理
    btn.addEventListener("click", e => {
      e.preventDefault();

      questions.forEach(qBox => {
        const name = qBox.dataset.question;
        const key = qBox.dataset.key;
        const selected = form.querySelector(`input[name="${name}"]:checked`);
        if (selected) {
          answers.push([key, selected.value]);
        }
      });

      console.log("現在のanswers:", answers);
      const prefilledUrl = generatePrefilledFormUrl(answers, baseurl);
      console.log(prefilledUrl);
      changeDisplay();
    });
  }

  setupSurvey("surveyForm", "PreSurveyBtn");
  setupSurvey("AftsurveyForm", "AftSurveyBtn");

  // ======== 介入画面（タイマー起動） ========
  function startTimer() {
    let timeLeft = 10;
    const timer = document.getElementById("timer");
    timer.textContent = timeLeft;
    const countdown = setInterval(() => {
      timeLeft--;
      timer.textContent = timeLeft;
      if (timeLeft <= 0) {
        clearInterval(countdown);
        timer.textContent = "終了！";
        changeDisplay();
      }
    }, 1000);
  }

  function changeDisplay() {
    screens[screen_ind].style.display = "none";
    screen_ind++;
    if (screen_ind < screens.length) {
      screens[screen_ind].style.display = "block";
      if (screens[screen_ind].id === "InterventionMode") {
        startTimer();
      }
    }
  }

  // ======== Google formへの転記 ========
  const baseurl = "https://docs.google.com/forms/d/e/1FAIpQLSdsbqueulSnjfVTd1DeLEFhAT4zLj5F4CZX0ZvxiLoCLqytDA/viewform?usp=pp_url";

  function generatePrefilledFormUrl(answers, baseUrl) {
  if (!Array.isArray(answers) || answers.length === 0) {
    console.warn("answers が空です。");
    return baseUrl;
  }

  // 各回答をURLエンコードして結合
  const params = answers
    .map(([key, value]) => `${encodeURIComponent(key)}=${encodeURIComponent(value)}`)
    .join("&");

  // URLを返す
  return `${baseUrl}&${params}`;
  }
</script>
</body>
</html>
